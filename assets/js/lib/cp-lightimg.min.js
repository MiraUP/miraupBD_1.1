$(function () {
    $.fn.cpLightimg = function () {

        var _img = this[0];

        var clear = function () {
            $("div.cp-lightoverlay").removeClass("cp-lightoverlay-in");
            $("img.cp-lightimg").css("transform", "")

            setTimeout(function () {
                $("div.cp-lightoverlay").remove();
                $("img.cp-lightimg").removeClass("cp-lightimg");
            }, 300);

            $('.single-page').css("z-index","0");

            $(window).unbind("scroll", clear);
        };

        $(window).scroll(clear);

        if (!$(_img).hasClass("cp-lightimg")) {
            var _param = {
                imgMaxWidth: (_img.naturalWidth > (window.innerWidth - 40) ? (window.innerWidth - 40) : _img.naturalWidth),
                imgMaxHeight: (_img.naturalHeight > (window.innerHeight - 40) ? (window.innerHeight - 40) : _img.naturalHeight),
                screenleftStart: ((window.innerWidth / 2) - (_img.width / 2)) - ($(_img).offset().left),
                screentopStart: (((window.innerHeight / 2) - (_img.height / 2)) - $(_img).offset().top) + $("html").scrollTop()
            };

            var _imgTransformScaleWidth = _param.imgMaxWidth / _img.width;
            var _imgTransformScaleHeight = _param.imgMaxHeight / _img.height;


            if (_img.naturalWidth > _img.naturalHeight) {
                var heightPx = (_param.imgMaxWidth / _img.naturalWidth) * _img.naturalHeight;
                _imgTransformScaleHeight = heightPx / _img.height;
            } else {
                var widthPx = (_param.imgMaxHeight / _img.naturalHeight) * _img.naturalWidth;
                _imgTransformScaleWidth = widthPx / _img.width;

                if (widthPx > _param.imgMaxWidth) {
                    var heightPx = (_param.imgMaxWidth / _img.naturalWidth) * _img.naturalHeight;
                    _imgTransformScaleHeight = heightPx / _img.height;

                    var widthPx = (heightPx / _img.naturalHeight) * _img.naturalWidth;
                    _imgTransformScaleWidth = widthPx / _img.width;
                }
            }

            $(_img)
                .addClass("cp-lightimg")
                .css("transform", `translate(${_param.screenleftStart}px, ${_param.screentopStart}px) scale(${_imgTransformScaleWidth / 1.6}, ${_imgTransformScaleHeight / 1.6})`);

            var $overlay = $(`<div class="cp-lightoverlay"><div>`);

            $(".wp-block-gallery").append($overlay);

            setTimeout(function () {
                $overlay.addClass("cp-lightoverlay-in");
                $overlay.click(clear);
            }, 10);

            $('.single-page').css("z-index","30");

        } else {
            clear();
        }
        
        return this;
    };
    
});